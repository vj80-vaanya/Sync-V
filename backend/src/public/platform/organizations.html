<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sync-V - Organizations</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/dashboard/css/style.css">
</head>
<body>
  <div id="nav-bar"></div>

  <div class="page">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:4px">
      <h1 class="page-title" style="margin-bottom:0">Organizations</h1>
      <button class="btn btn-primary" onclick="openCreateModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Create Organization
      </button>
    </div>
    <p class="page-subtitle">Manage all tenant organizations on the platform</p>

    <div class="card">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Organization</th>
              <th>Slug</th>
              <th>Plan</th>
              <th>Status</th>
              <th>Devices</th>
              <th>Users</th>
              <th>Storage Used</th>
            </tr>
          </thead>
          <tbody id="orgs-tbody">
          </tbody>
        </table>
      </div>
      <div id="orgs-empty" style="display:none"></div>
    </div>
  </div>

  <!-- Create Organization Modal -->
  <div class="modal-overlay" id="create-modal" style="display:none">
    <div class="modal-card" style="max-width:500px">
      <div class="modal-header">
        <h3>Create Organization</h3>
        <button class="modal-close" onclick="closeCreateModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="create-form">
          <div class="form-group">
            <label for="org-name">Organization Name</label>
            <input type="text" id="org-name" placeholder="Acme Corp" required>
          </div>
          <div class="form-group">
            <label for="org-slug">Slug</label>
            <input type="text" id="org-slug" placeholder="acme-corp" required pattern="[a-z0-9\-]+" title="Lowercase letters, numbers, and hyphens only">
          </div>
          <div class="form-group">
            <label for="org-plan">Plan</label>
            <select id="org-plan" style="width:100%;padding:11px 14px;border:1px solid var(--border);border-radius:8px;font-size:15px;font-family:var(--font-sans);color:var(--text-dark);background:var(--card);outline:none">
              <option value="free">Free</option>
              <option value="starter">Starter</option>
              <option value="professional" selected>Professional</option>
              <option value="enterprise">Enterprise</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeCreateModal()">Cancel</button>
        <button class="btn btn-primary" id="create-btn" onclick="createOrg()">Create</button>
      </div>
    </div>
  </div>

  <script src="/dashboard/js/app.js"></script>
  <script>
    /* ---- Platform Auth ---- */
    var API_BASE = window.location.origin;

    var PLATFORM_AUTH = {
      USER_KEY: 'platform_user',
      getUser: function() { try { return JSON.parse(localStorage.getItem(this.USER_KEY)); } catch(e) { return null; } },
      isLoggedIn: function() { return !!this.getUser(); },
      requireAuth: function() {
        if (!this.isLoggedIn()) { window.location.href = '/dashboard/platform/'; return false; }
        return true;
      },
      logout: function() {
        fetch('/api/auth/logout', { method: 'POST', credentials: 'same-origin' }).catch(function(){});
        localStorage.removeItem(this.USER_KEY);
        window.location.href = '/dashboard/platform/';
      }
    };

    if (!PLATFORM_AUTH.requireAuth()) throw new Error('Not authenticated');

    /* ---- API helper ---- */
    async function platformApi(path, options) {
      var headers = { 'Content-Type': 'application/json' };
      var config = Object.assign({}, options || {}, { headers: headers, credentials: 'same-origin' });
      var response;
      try {
        response = await fetch(API_BASE + path, config);
      } catch (err) {
        showToast('Network error — check your connection', 'error');
        return null;
      }
      if (response.status === 401) {
        showToast('Session expired — please log in again', 'warning');
        setTimeout(function() { PLATFORM_AUTH.logout(); }, 1500);
        return null;
      }
      if (response.status >= 500) {
        showToast('Server error — please try again', 'error');
      }
      if (response.status === 204) return null;
      return response.json();
    }

    /* ---- Platform Nav ---- */
    var PLATFORM_ICONS = {
      overview: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>',
      orgs: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>',
      audit: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',
      logout: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>'
    };

    function renderPlatformNav(activePage) {
      var user = PLATFORM_AUTH.getUser();
      var nav = document.getElementById('nav-bar');
      if (!nav) return;

      var pages = [
        { id: 'overview', label: 'Overview', href: '/dashboard/platform/overview.html', icon: PLATFORM_ICONS.overview },
        { id: 'organizations', label: 'Organizations', href: '/dashboard/platform/organizations.html', icon: PLATFORM_ICONS.orgs },
        { id: 'audit', label: 'Audit Log', href: '/dashboard/platform/audit.html', icon: PLATFORM_ICONS.audit }
      ];

      var linksHtml = pages.map(function(p) {
        var cls = p.id === activePage ? ' class="active"' : '';
        return '<a href="' + p.href + '"' + cls + '>' + p.icon + ' ' + p.label + '</a>';
      }).join('');

      var userName = user ? user.username : '';
      var userRole = user ? (user.role || 'admin') : '';

      nav.className = 'nav-bar';
      nav.innerHTML =
        '<div class="nav-brand"><span class="logo-icon logo-icon-nav">' + BRAND_LOGO + '</span><span class="nav-brand-gradient">Sync-V Platform</span></div>' +
        '<button class="nav-hamburger" onclick="toggleMobileNav()" aria-label="Menu">' + ICONS.hamburger + '</button>' +
        '<div class="nav-links" id="nav-links">' + linksHtml + '</div>' +
        '<div class="nav-user">' +
          '<button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme"></button>' +
          '<span>' + escapeHtml(userName) + '</span>' +
          '<span class="role">' + escapeHtml(userRole) + '</span>' +
          '<button class="logout-btn" onclick="PLATFORM_AUTH.logout()">' + PLATFORM_ICONS.logout + ' Logout</button>' +
        '</div>';

      var currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
      updateThemeButtons(currentTheme);
    }

    function toggleMobileNav() {
      var links = document.getElementById('nav-links');
      if (links) links.classList.toggle('open');
    }

    renderPlatformNav('organizations');
    renderFooter();

    /* ---- Usage bar color helper ---- */
    function usageBarColor(pct) {
      if (pct >= 80) return 'var(--danger)';
      if (pct >= 60) return 'var(--warning)';
      return 'var(--success)';
    }

    /* ---- Status badge ---- */
    function orgStatusBadge(status) {
      if (status === 'suspended') {
        return '<span class="badge badge-danger"><span class="badge-dot"></span>Suspended</span>';
      }
      return '<span class="badge badge-success"><span class="badge-dot"></span>Active</span>';
    }

    /* ---- Plan badge ---- */
    function planBadge(plan) {
      var colorMap = { free: 'muted', starter: 'info', professional: 'success', enterprise: 'warning' };
      var cls = colorMap[(plan || '').toLowerCase()] || 'muted';
      return '<span class="badge badge-' + cls + '" style="text-transform:capitalize">' + escapeHtml(plan || 'free') + '</span>';
    }

    /* ---- Render organizations table ---- */
    function renderOrgs(orgs) {
      var tbody = document.getElementById('orgs-tbody');
      var emptyEl = document.getElementById('orgs-empty');

      if (!orgs || orgs.length === 0) {
        tbody.innerHTML = '';
        emptyEl.style.display = 'block';
        emptyEl.innerHTML =
          '<div class="empty-state">' +
            '<div class="empty-icon-circle">' +
              '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>' +
            '</div>' +
            '<h3>No organizations yet</h3>' +
            '<p>Create your first organization to get started.</p>' +
          '</div>';
        return;
      }

      emptyEl.style.display = 'none';

      tbody.innerHTML = orgs.map(function(org) {
        var storageBytes = org.storage_used_bytes || org.storageUsed || 0;
        var maxStorage = org.max_storage_bytes || org.maxStorage || 1;
        var storagePct = maxStorage > 0 ? Math.min(Math.round((storageBytes / maxStorage) * 100), 100) : 0;

        return '<tr onclick="window.location.href=\'/dashboard/platform/org-detail.html?id=' + encodeURIComponent(org.id) + '\'" style="cursor:pointer">' +
          '<td><strong style="color:var(--text-dark)">' + escapeHtml(org.name) + '</strong></td>' +
          '<td><span class="text-mono">' + escapeHtml(org.slug) + '</span></td>' +
          '<td>' + planBadge(org.plan) + '</td>' +
          '<td>' + orgStatusBadge(org.status) + '</td>' +
          '<td>' + (org.device_count !== undefined ? org.device_count : (org.deviceCount || 0)) + '</td>' +
          '<td>' + (org.user_count !== undefined ? org.user_count : (org.userCount || 0)) + '</td>' +
          '<td style="min-width:160px">' +
            '<div style="display:flex;justify-content:space-between;margin-bottom:4px;font-size:12px">' +
              '<span style="color:var(--text-muted)">' + formatSize(storageBytes) + '</span>' +
              '<span style="color:var(--text-muted)">' + storagePct + '%</span>' +
            '</div>' +
            '<div style="height:6px;background:var(--border-light);border-radius:3px;overflow:hidden">' +
              '<div style="height:100%;width:' + storagePct + '%;background:' + usageBarColor(storagePct) + ';border-radius:3px;transition:width 0.4s ease"></div>' +
            '</div>' +
          '</td>' +
        '</tr>';
      }).join('');

      staggerRows('orgs-tbody');
    }

    /* ---- Load organizations ---- */
    async function loadOrgs() {
      document.getElementById('orgs-tbody').innerHTML = skeletonRows(5, 7);
      var data = await platformApi('/api/platform/organizations');
      if (!data) return;
      // API may return array directly or { organizations: [...] }
      var orgs = Array.isArray(data) ? data : (data.organizations || []);
      renderOrgs(orgs);
    }

    /* ---- Create modal ---- */
    function openCreateModal() {
      document.getElementById('create-modal').style.display = 'flex';
      document.getElementById('org-name').focus();
    }

    function closeCreateModal() {
      document.getElementById('create-modal').style.display = 'none';
      document.getElementById('create-form').reset();
    }

    // Close modal on overlay click
    document.getElementById('create-modal').addEventListener('click', function(e) {
      if (e.target === this) closeCreateModal();
    });

    // Close modal on ESC
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') closeCreateModal();
    });

    // Auto-generate slug from name
    document.getElementById('org-name').addEventListener('input', function() {
      var slug = this.value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
      document.getElementById('org-slug').value = slug;
    });

    async function createOrg() {
      var name = document.getElementById('org-name').value.trim();
      var slug = document.getElementById('org-slug').value.trim();
      var plan = document.getElementById('org-plan').value;

      if (!name || !slug) {
        showToast('Name and slug are required', 'error');
        return;
      }

      var btn = document.getElementById('create-btn');
      btn.disabled = true;
      btn.textContent = 'Creating...';

      var result = await platformApi('/api/platform/organizations', {
        method: 'POST',
        body: JSON.stringify({ name: name, slug: slug, plan: plan })
      });

      btn.disabled = false;
      btn.innerHTML = 'Create';

      if (result && !result.error) {
        showToast('Organization "' + name + '" created successfully', 'success');
        closeCreateModal();
        loadOrgs();
      } else if (result && result.error) {
        showToast(result.error, 'error');
      }
    }

    loadOrgs();
  </script>
</body>
</html>
