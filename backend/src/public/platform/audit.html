<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sync-V - Platform Audit Log</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/dashboard/css/style.css">
</head>
<body>
  <div id="nav-bar"></div>

  <div class="page">
    <h1 class="page-title">Audit Log</h1>
    <p class="page-subtitle">Platform structural changes and administrative actions</p>

    <div class="filter-bar">
      <div>
        <label style="font-size:12px;font-weight:600;color:var(--text-muted);display:block;margin-bottom:4px">From</label>
        <input type="date" id="filter-from">
      </div>
      <div>
        <label style="font-size:12px;font-weight:600;color:var(--text-muted);display:block;margin-bottom:4px">To</label>
        <input type="date" id="filter-to">
      </div>
      <div style="align-self:flex-end">
        <button class="btn btn-primary" onclick="loadAudit()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          Filter
        </button>
      </div>
      <div style="align-self:flex-end">
        <button class="btn btn-outline" onclick="clearFilters()">Clear</button>
      </div>
    </div>

    <div class="card">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Actor</th>
              <th>Action</th>
              <th>Target</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody id="audit-tbody">
          </tbody>
        </table>
      </div>
      <div id="audit-empty" style="display:none"></div>
    </div>
  </div>

  <script src="/dashboard/js/app.js"></script>
  <script>
    /* ---- Platform Auth ---- */
    var API_BASE = window.location.origin;

    var PLATFORM_AUTH = {
      USER_KEY: 'platform_user',
      getUser: function() { try { return JSON.parse(localStorage.getItem(this.USER_KEY)); } catch(e) { return null; } },
      isLoggedIn: function() { return !!this.getUser(); },
      requireAuth: function() {
        if (!this.isLoggedIn()) { window.location.href = '/dashboard/platform/'; return false; }
        return true;
      },
      logout: function() {
        fetch('/api/auth/logout', { method: 'POST', credentials: 'same-origin' }).catch(function(){});
        localStorage.removeItem(this.USER_KEY);
        window.location.href = '/dashboard/platform/';
      }
    };

    if (!PLATFORM_AUTH.requireAuth()) throw new Error('Not authenticated');

    /* ---- API helper ---- */
    async function platformApi(path, options) {
      var headers = { 'Content-Type': 'application/json' };
      var config = Object.assign({}, options || {}, { headers: headers, credentials: 'same-origin' });
      var response;
      try {
        response = await fetch(API_BASE + path, config);
      } catch (err) {
        showToast('Network error — check your connection', 'error');
        return null;
      }
      if (response.status === 401) {
        showToast('Session expired — please log in again', 'warning');
        setTimeout(function() { PLATFORM_AUTH.logout(); }, 1500);
        return null;
      }
      if (response.status >= 500) {
        showToast('Server error — please try again', 'error');
      }
      if (response.status === 204) return null;
      return response.json();
    }

    /* ---- Platform Nav ---- */
    var PLATFORM_ICONS = {
      overview: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>',
      orgs: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>',
      audit: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',
      logout: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>'
    };

    function renderPlatformNav(activePage) {
      var user = PLATFORM_AUTH.getUser();
      var nav = document.getElementById('nav-bar');
      if (!nav) return;

      var pages = [
        { id: 'overview', label: 'Overview', href: '/dashboard/platform/overview.html', icon: PLATFORM_ICONS.overview },
        { id: 'organizations', label: 'Organizations', href: '/dashboard/platform/organizations.html', icon: PLATFORM_ICONS.orgs },
        { id: 'audit', label: 'Audit Log', href: '/dashboard/platform/audit.html', icon: PLATFORM_ICONS.audit }
      ];

      var linksHtml = pages.map(function(p) {
        var cls = p.id === activePage ? ' class="active"' : '';
        return '<a href="' + p.href + '"' + cls + '>' + p.icon + ' ' + p.label + '</a>';
      }).join('');

      var userName = user ? user.username : '';
      var userRole = user ? (user.role || 'admin') : '';

      nav.className = 'nav-bar';
      nav.innerHTML =
        '<div class="nav-brand"><span class="logo-icon logo-icon-nav">' + BRAND_LOGO + '</span><span class="nav-brand-gradient">Sync-V Platform</span></div>' +
        '<button class="nav-hamburger" onclick="toggleMobileNav()" aria-label="Menu">' + ICONS.hamburger + '</button>' +
        '<div class="nav-links" id="nav-links">' + linksHtml + '</div>' +
        '<div class="nav-user">' +
          '<button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme"></button>' +
          '<span>' + escapeHtml(userName) + '</span>' +
          '<span class="role">' + escapeHtml(userRole) + '</span>' +
          '<button class="logout-btn" onclick="PLATFORM_AUTH.logout()">' + PLATFORM_ICONS.logout + ' Logout</button>' +
        '</div>';

      var currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
      updateThemeButtons(currentTheme);
    }

    function toggleMobileNav() {
      var links = document.getElementById('nav-links');
      if (links) links.classList.toggle('open');
    }

    renderPlatformNav('audit');
    renderFooter();

    /* ---- Action badge ---- */
    function actionBadge(action) {
      if (!action) return '<span class="badge badge-muted">unknown</span>';
      var a = action.toLowerCase();
      if (a.indexOf('create') !== -1 || a.indexOf('add') !== -1) return '<span class="badge badge-success">' + escapeHtml(action) + '</span>';
      if (a.indexOf('delete') !== -1 || a.indexOf('remove') !== -1) return '<span class="badge badge-danger">' + escapeHtml(action) + '</span>';
      if (a.indexOf('suspend') !== -1) return '<span class="badge badge-danger">' + escapeHtml(action) + '</span>';
      if (a.indexOf('activate') !== -1) return '<span class="badge badge-success">' + escapeHtml(action) + '</span>';
      if (a.indexOf('update') !== -1 || a.indexOf('edit') !== -1 || a.indexOf('change') !== -1) return '<span class="badge badge-warning">' + escapeHtml(action) + '</span>';
      return '<span class="badge badge-info">' + escapeHtml(action) + '</span>';
    }

    /* ---- Format details ---- */
    function formatDetails(details) {
      if (!details) return '<span style="color:var(--text-muted)">-</span>';
      if (typeof details === 'string') return '<span style="font-size:13px;color:var(--text-light)">' + escapeHtml(details) + '</span>';
      if (typeof details === 'object') {
        var str = JSON.stringify(details);
        if (str.length > 80) str = str.substring(0, 80) + '...';
        return '<span class="text-mono" style="font-size:11px">' + escapeHtml(str) + '</span>';
      }
      return '<span style="color:var(--text-muted)">' + escapeHtml(String(details)) + '</span>';
    }

    /* ---- Render audit table ---- */
    function renderAudit(entries) {
      var tbody = document.getElementById('audit-tbody');
      var emptyEl = document.getElementById('audit-empty');

      if (!entries || entries.length === 0) {
        tbody.innerHTML = '';
        emptyEl.style.display = 'block';
        emptyEl.innerHTML =
          '<div class="empty-state">' +
            '<div class="empty-icon-circle">' +
              '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>' +
            '</div>' +
            '<h3>No audit entries</h3>' +
            '<p>No platform structural changes have been recorded yet.</p>' +
          '</div>';
        return;
      }

      emptyEl.style.display = 'none';

      tbody.innerHTML = entries.map(function(entry) {
        var timestamp = entry.timestamp || entry.created_at || entry.createdAt || '';
        var actor = entry.actor || entry.actor_username || entry.user || '';
        var action = entry.action || '';
        var target = entry.target || entry.target_type || '';
        var details = entry.details || entry.metadata || '';

        return '<tr>' +
          '<td style="white-space:nowrap;font-size:13px;color:var(--text-light)">' + formatDate(timestamp) + '</td>' +
          '<td><strong style="color:var(--text-dark)">' + escapeHtml(actor) + '</strong></td>' +
          '<td>' + actionBadge(action) + '</td>' +
          '<td style="font-size:13px">' + escapeHtml(target) + '</td>' +
          '<td>' + formatDetails(details) + '</td>' +
        '</tr>';
      }).join('');

      staggerRows('audit-tbody');
    }

    /* ---- Load audit data ---- */
    async function loadAudit() {
      document.getElementById('audit-tbody').innerHTML = skeletonRows(8, 5);
      document.getElementById('audit-empty').style.display = 'none';

      var from = document.getElementById('filter-from').value;
      var to = document.getElementById('filter-to').value;

      var queryParams = [];
      if (from) queryParams.push('from=' + encodeURIComponent(from));
      if (to) queryParams.push('to=' + encodeURIComponent(to));
      var queryString = queryParams.length > 0 ? '?' + queryParams.join('&') : '';

      var data = await platformApi('/api/platform/audit' + queryString);
      if (!data) return;

      // API may return array directly or { entries: [...] } or { audit: [...] }
      var entries = Array.isArray(data) ? data : (data.entries || data.audit || []);
      renderAudit(entries);
    }

    /* ---- Clear filters ---- */
    function clearFilters() {
      document.getElementById('filter-from').value = '';
      document.getElementById('filter-to').value = '';
      loadAudit();
    }

    loadAudit();
  </script>
</body>
</html>
