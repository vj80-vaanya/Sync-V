<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sync-V - Firmware</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/dashboard/css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div id="nav-bar"></div>

  <div class="page">
    <h1 class="page-title">Firmware Management</h1>
    <p class="page-subtitle">Firmware packages for your device fleet</p>

    <div class="stats-grid" id="fw-stats"></div>

    <div class="chart-card" style="margin-bottom: 24px; max-width: 400px;">
      <div class="chart-title">Firmware Distribution</div>
      <div class="chart-wrap"><canvas id="chart-fw-distribution"></canvas></div>
    </div>

    <!-- Upload form (admin/technician only) -->
    <div id="upload-section" style="display:none">
      <div class="form-section">
        <h3>Upload Firmware Package</h3>

        <!-- Drag & Drop Zone -->
        <div class="drop-zone" id="fw-drop-zone">
          <div class="drop-zone-icon" id="drop-zone-icon-wrap"></div>
          <div class="drop-zone-text">Drop firmware files here or click to browse</div>
          <div class="drop-zone-hint">Supported formats: .bin, .hex, .fw</div>
          <input type="file" id="fw-file-input" accept=".bin,.hex,.fw">
        </div>

        <!-- File preview (shown after file selected) -->
        <div id="fw-file-preview" style="display:none"></div>

        <!-- Upload progress bar -->
        <div id="fw-progress" style="display:none">
          <div class="progress-bar-wrap"><div class="progress-bar" id="fw-progress-bar"></div></div>
        </div>

        <form id="upload-form">
          <div class="form-row">
            <div class="form-group">
              <label>Version</label>
              <input type="text" id="fw-version" placeholder="e.g. 2.0.0" required>
            </div>
            <div class="form-group">
              <label>Device Type</label>
              <input type="text" id="fw-device-type" placeholder="e.g. typeA" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Filename</label>
              <input type="text" id="fw-filename" placeholder="e.g. fw_v2.0.bin" required>
            </div>
            <div class="form-group">
              <label>Size (bytes)</label>
              <input type="number" id="fw-size" placeholder="e.g. 10240" required>
            </div>
          </div>
          <div class="form-row full">
            <div class="form-group">
              <label>SHA256 Hash</label>
              <input type="text" id="fw-sha256" placeholder="64-character hex hash" required>
            </div>
          </div>
          <div class="form-row full">
            <div class="form-group">
              <label>Description</label>
              <input type="text" id="fw-description" placeholder="Release notes">
            </div>
          </div>
          <button type="submit" class="btn btn-primary" id="upload-btn">Upload Firmware</button>
        </form>
      </div>
    </div>

    <div class="card">
      <div class="card-title">All Firmware Packages</div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Version</th>
              <th>Device Type</th>
              <th>Filename</th>
              <th>Size</th>
              <th>SHA256</th>
              <th>Released</th>
              <th>Description</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="fw-table"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="/dashboard/js/auth.js"></script>
  <script src="/dashboard/js/api.js"></script>
  <script src="/dashboard/js/app.js"></script>
  <script>
    if (!AUTH.requireAuth()) throw new Error('Not authenticated');
    renderNavBar('firmware');
    renderFooter();

    var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.color = isDark ? '#94a3b8' : '#64748b';

    // Show skeleton loading
    document.getElementById('fw-stats').innerHTML = skeletonCards(3);
    document.getElementById('fw-table').innerHTML = skeletonRows(4, 8);

    // Add upload icon to submit button
    document.getElementById('upload-btn').innerHTML = ICONS.upload + ' Upload Firmware';

    // Drop zone icon
    document.getElementById('drop-zone-icon-wrap').innerHTML = ICONS.upload;

    // Show upload form for admin/technician
    var user = AUTH.getUser();
    if (user && (user.role === 'admin' || user.role === 'technician')) {
      document.getElementById('upload-section').style.display = 'block';
    }

    // --- Drag & Drop Logic ---
    var dropZone = document.getElementById('fw-drop-zone');
    var fileInput = document.getElementById('fw-file-input');
    var selectedFile = null;

    dropZone.addEventListener('dragover', function(e) {
      e.preventDefault();
      dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', function(e) {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
    });

    dropZone.addEventListener('drop', function(e) {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      if (e.dataTransfer.files.length > 0) handleFileSelect(e.dataTransfer.files[0]);
    });

    fileInput.addEventListener('change', function() {
      if (fileInput.files.length > 0) handleFileSelect(fileInput.files[0]);
    });

    function handleFileSelect(file) {
      var validExts = ['.bin', '.hex', '.fw'];
      var ext = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
      if (validExts.indexOf(ext) === -1) {
        showToast('Invalid file type. Supported: .bin, .hex, .fw', 'error');
        return;
      }

      selectedFile = file;

      // Auto-fill filename and size
      document.getElementById('fw-filename').value = file.name;
      document.getElementById('fw-size').value = file.size;

      // Show file preview
      var preview = document.getElementById('fw-file-preview');
      preview.style.display = 'block';
      preview.innerHTML =
        '<div class="file-preview">' +
          '<div class="file-preview-icon">' + ICONS.firmware + '</div>' +
          '<div class="file-preview-info">' +
            '<div class="file-preview-name">' + escapeHtml(file.name) + '</div>' +
            '<div class="file-preview-size">' + formatSize(file.size) + '</div>' +
          '</div>' +
          '<button type="button" class="file-preview-remove" onclick="clearFileSelection()" title="Remove">&times;</button>' +
        '</div>';

      // Hide drop zone
      dropZone.style.display = 'none';
    }

    function clearFileSelection() {
      selectedFile = null;
      fileInput.value = '';
      document.getElementById('fw-file-preview').style.display = 'none';
      document.getElementById('fw-filename').value = '';
      document.getElementById('fw-size').value = '';
      dropZone.style.display = '';
    }

    var allFirmware = [];

    async function loadFirmware() {
      var summary = await apiGet('/api/dashboard/firmware');
      allFirmware = await apiGet('/api/firmware') || [];

      if (summary) {
        var entries = Object.entries(summary.byDeviceType);
        var statsHtml = '<div class="stat-card stat-border-indigo">' +
          '<div class="stat-icon" style="background:var(--primary-50);color:var(--primary)">' + ICONS.package + '</div>' +
          '<div class="stat-value">' + summary.totalFirmwarePackages + '</div>' +
          '<div class="stat-label">Total Packages</div>' +
        '</div>';
        entries.forEach(function(e) {
          statsHtml += '<div class="stat-card">' +
            '<div class="stat-value">' + e[1] + '</div>' +
            '<div class="stat-label">' + escapeHtml(e[0]) + '</div>' +
          '</div>';
        });
        document.getElementById('fw-stats').innerHTML = statsHtml;
        staggerCards('#fw-stats');

        // Doughnut chart: firmware distribution by device type
        if (entries.length > 0) {
          var chartColors = ['#6366f1', '#818cf8', '#a5b4fc', '#c7d2fe', '#4f46e5', '#4338ca'];
          new Chart(document.getElementById('chart-fw-distribution'), {
            type: 'doughnut',
            data: {
              labels: entries.map(function(e) { return e[0]; }),
              datasets: [{
                data: entries.map(function(e) { return e[1]; }),
                backgroundColor: entries.map(function(_, i) { return chartColors[i % chartColors.length]; }),
                borderWidth: 0,
                hoverOffset: 8
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              cutout: '60%',
              plugins: {
                legend: { position: 'bottom', labels: { padding: 16, usePointStyle: true, pointStyleWidth: 10 } }
              }
            }
          });
        }
      }

      renderFirmware(allFirmware);

      // Setup sortable columns
      makeSortable('fw-table', allFirmware, renderFirmware, [
        { key: function(fw) { return fw.version; }, type: 'string' },
        { key: function(fw) { return fw.device_type; }, type: 'string' },
        { key: function(fw) { return fw.filename; }, type: 'string' },
        { key: function(fw) { return fw.size; }, type: 'number' },
        null, // SHA256 — not sortable
        { key: function(fw) { return fw.release_date; }, type: 'date' },
        null, // Description — not sortable
        null  // Actions — not sortable
      ]);
    }

    var canDelete = user && (user.role === 'admin' || user.role === 'technician');

    function renderFirmware(fwList) {
      var tbody = document.getElementById('fw-table');
      if (fwList.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="empty-state">' +
          '<div class="empty-icon-circle">' + ICONS.emptyBox + '</div>' +
          '<h3>No firmware packages uploaded</h3></td></tr>';
        return;
      }

      tbody.innerHTML = fwList.map(function(fw) {
        var actionsHtml = canDelete
          ? '<button class="btn btn-danger btn-sm" onclick="deleteFirmware(\'' + escapeHtml(fw.id) + '\',\'' + escapeHtml(fw.version) + '\')" title="Delete">' + ICONS.trash + '</button>'
          : '-';
        return '<tr style="cursor:default">' +
          '<td><strong>' + escapeHtml(fw.version) + '</strong></td>' +
          '<td><span class="badge badge-muted">' + escapeHtml(fw.device_type) + '</span></td>' +
          '<td>' + escapeHtml(fw.filename) + '</td>' +
          '<td>' + formatSize(fw.size) + '</td>' +
          '<td class="text-mono"><span class="text-truncate">' + escapeHtml(fw.sha256) + '</span></td>' +
          '<td>' + formatDate(fw.release_date) + '</td>' +
          '<td>' + escapeHtml(fw.description || '-') + '</td>' +
          '<td>' + actionsHtml + '</td>' +
        '</tr>';
      }).join('');
      staggerRows('fw-table');
    }

    document.getElementById('upload-form').addEventListener('submit', async function(e) {
      e.preventDefault();

      var progressWrap = document.getElementById('fw-progress');
      var progressBar = document.getElementById('fw-progress-bar');
      var uploadBtn = document.getElementById('upload-btn');

      // Show progress
      progressWrap.style.display = 'block';
      progressBar.classList.add('indeterminate');
      uploadBtn.disabled = true;
      uploadBtn.innerHTML = '<span class="spinner spinner-sm"></span> Uploading...';

      var body = {
        version: document.getElementById('fw-version').value.trim(),
        deviceType: document.getElementById('fw-device-type').value.trim(),
        filename: document.getElementById('fw-filename').value.trim(),
        size: parseInt(document.getElementById('fw-size').value, 10) || 0,
        sha256: document.getElementById('fw-sha256').value.trim().toLowerCase(),
        description: document.getElementById('fw-description').value.trim()
      };

      var result = await apiPost('/api/firmware', body);

      // Reset progress
      progressBar.classList.remove('indeterminate');
      progressWrap.style.display = 'none';
      uploadBtn.disabled = false;
      uploadBtn.innerHTML = ICONS.upload + ' Upload Firmware';

      if (result && result.firmwareId) {
        showToast('Firmware uploaded successfully', 'success');
        document.getElementById('upload-form').reset();
        clearFileSelection();
        loadFirmware();
      } else if (result && result.error) {
        showToast(result.error, 'error');
      }
    });

    function deleteFirmware(fwId, version) {
      showConfirmModal(
        'Delete Firmware',
        'Are you sure you want to delete firmware v' + version + '? This action cannot be undone.',
        async function() {
          var result = await apiDelete('/api/firmware/' + encodeURIComponent(fwId));
          if (result && result.success) {
            showToast('Firmware deleted: v' + version, 'success');
            loadFirmware();
          } else {
            showToast((result && result.error) || 'Failed to delete firmware', 'error');
          }
        }
      );
    }

    loadFirmware();
  </script>
</body>
</html>
