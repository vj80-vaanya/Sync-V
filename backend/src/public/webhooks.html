<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sync-V - Webhooks</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/dashboard/css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div id="nav-bar"></div>

  <div class="page">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:8px">
      <div>
        <h1 class="page-title" style="margin-bottom:4px">Webhooks</h1>
        <p class="page-subtitle" style="margin-bottom:0">Configure event notifications for external services</p>
      </div>
      <button class="btn btn-primary" onclick="openCreateModal()">+ Create Webhook</button>
    </div>

    <!-- Webhooks Table -->
    <div class="card">
      <div class="card-title">Configured Webhooks</div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>URL</th>
              <th>Events</th>
              <th>Status</th>
              <th>Failures</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="webhooks-table"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Create Webhook Modal -->
  <div id="create-webhook-modal" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeCreateModal()">
    <div class="modal-card" style="max-width:560px">
      <div class="modal-header">
        <h3>Create Webhook</h3>
        <button class="modal-close" onclick="closeCreateModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Webhook URL</label>
          <input type="url" id="new-webhook-url" placeholder="https://example.com/webhook" style="width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:8px;font-size:14px;font-family:var(--font-sans);color:var(--text-dark);outline:none">
        </div>
        <div style="margin-top:16px">
          <label style="display:block;font-size:13px;font-weight:600;color:var(--text-mid);margin-bottom:10px">Events</label>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px" id="events-grid">
            <label style="display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500;color:var(--text-mid);cursor:pointer">
              <input type="checkbox" value="device.online" checked> device.online
            </label>
            <label style="display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500;color:var(--text-mid);cursor:pointer">
              <input type="checkbox" value="device.offline" checked> device.offline
            </label>
            <label style="display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500;color:var(--text-mid);cursor:pointer">
              <input type="checkbox" value="log.uploaded"> log.uploaded
            </label>
            <label style="display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500;color:var(--text-mid);cursor:pointer">
              <input type="checkbox" value="firmware.uploaded"> firmware.uploaded
            </label>
            <label style="display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500;color:var(--text-mid);cursor:pointer">
              <input type="checkbox" value="psk.rotated"> psk.rotated
            </label>
            <label style="display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500;color:var(--text-mid);cursor:pointer">
              <input type="checkbox" value="device.registered"> device.registered
            </label>
            <label style="display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500;color:var(--text-mid);cursor:pointer">
              <input type="checkbox" value="cluster.updated"> cluster.updated
            </label>
            <label style="display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500;color:var(--text-mid);cursor:pointer">
              <input type="checkbox" value="user.created"> user.created
            </label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeCreateModal()">Cancel</button>
        <button class="btn btn-primary" onclick="createWebhook()">Create Webhook</button>
      </div>
    </div>
  </div>

  <script src="/dashboard/js/auth.js"></script>
  <script src="/dashboard/js/api.js"></script>
  <script src="/dashboard/js/app.js"></script>
  <script>
    if (!AUTH.requireAuth()) throw new Error('Not authenticated');

    // Build extended nav inline
    (function() {
      var user = AUTH.getUser();
      var pages = [
        { id: 'overview', label: 'Overview', href: '/dashboard/overview.html', icon: ICONS.overview },
        { id: 'devices', label: 'Devices', href: '/dashboard/devices.html', icon: ICONS.devices },
        { id: 'clusters', label: 'Clusters', href: '/dashboard/clusters.html', icon: ICONS.firmware },
        { id: 'logs', label: 'Logs', href: '/dashboard/logs.html', icon: ICONS.logs },
        { id: 'firmware', label: 'Firmware', href: '/dashboard/firmware.html', icon: ICONS.firmware },
        { id: 'team', label: 'Team', href: '/dashboard/team.html', icon: ICONS.devices },
        { id: 'api-keys', label: 'API Keys', href: '/dashboard/api-keys.html', icon: ICONS.firmware },
        { id: 'webhooks', label: 'Webhooks', href: '/dashboard/webhooks.html', icon: ICONS.logs },
        { id: 'audit', label: 'Audit', href: '/dashboard/audit.html', icon: ICONS.logs },
        { id: 'usage', label: 'Usage', href: '/dashboard/usage.html', icon: ICONS.overview }
      ];
      var linksHtml = pages.map(function(p) {
        var cls = p.id === 'webhooks' ? ' class="active"' : '';
        return '<a href="' + p.href + '"' + cls + '>' + p.icon + ' ' + p.label + '</a>';
      }).join('');
      var userName = user ? user.username : '';
      var userRole = user ? user.role : '';
      var nav = document.getElementById('nav-bar');
      nav.className = 'nav-bar';
      nav.innerHTML =
        '<div class="nav-brand"><span class="logo-icon logo-icon-nav">' + BRAND_LOGO + '</span><span class="nav-brand-gradient">Sync-V</span></div>' +
        '<button class="nav-hamburger" onclick="toggleMobileNav()" aria-label="Menu">' + ICONS.hamburger + '</button>' +
        '<div class="nav-links" id="nav-links">' + linksHtml + '</div>' +
        '<div class="nav-user">' +
          '<button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme"></button>' +
          '<span>' + userName + '</span>' +
          '<span class="role">' + userRole + '</span>' +
          '<button class="logout-btn" onclick="AUTH.logout()">' + ICONS.logout + ' Logout</button>' +
        '</div>';
      updateThemeButtons(document.documentElement.getAttribute('data-theme') || 'dark');
    })();
    renderFooter();

    // Show skeleton loading
    document.getElementById('webhooks-table').innerHTML = skeletonRows(3, 6);

    var allWebhooks = [];

    async function loadWebhooks() {
      allWebhooks = await apiGet('/api/org/webhooks') || [];
      renderWebhooks();
    }

    function renderWebhooks() {
      var tbody = document.getElementById('webhooks-table');
      if (allWebhooks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">' +
          '<div class="empty-icon-circle">' + ICONS.emptyBox + '</div>' +
          '<h3>No webhooks configured</h3><p>Create a webhook to receive event notifications</p></td></tr>';
        return;
      }
      tbody.innerHTML = allWebhooks.map(function(w) {
        var events = (w.events || []).map(function(e) {
          return '<span class="badge badge-muted" style="margin:1px 2px;font-size:11px">' + escapeHtml(e) + '</span>';
        }).join('');
        if (!events) events = '<span style="color:var(--text-muted);font-size:12px">None</span>';

        var isActive = w.active !== false && w.status !== 'inactive';
        var statusBadgeHtml = isActive
          ? '<span class="badge badge-success"><span class="badge-dot"></span>Active</span>'
          : '<span class="badge badge-muted"><span class="badge-dot"></span>Inactive</span>';

        var failCount = w.failure_count || w.failureCount || 0;
        var failBadge = failCount > 0
          ? '<span class="badge badge-danger">' + failCount + '</span>'
          : '<span style="color:var(--text-muted)">0</span>';

        var toggleLabel = isActive ? 'Disable' : 'Enable';
        var toggleClass = isActive ? 'btn-outline' : 'btn-secondary';

        return '<tr style="cursor:default">' +
          '<td><span class="text-mono" style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:inline-block">' + escapeHtml(w.url) + '</span></td>' +
          '<td style="max-width:220px">' + events + '</td>' +
          '<td>' + statusBadgeHtml + '</td>' +
          '<td>' + failBadge + '</td>' +
          '<td>' + formatDate(w.created_at || w.createdAt) + '</td>' +
          '<td style="white-space:nowrap">' +
            '<button class="btn ' + toggleClass + ' btn-sm" style="margin-right:4px" onclick="toggleWebhook(\'' + escapeHtml(w.id) + '\', ' + !isActive + ')">' + toggleLabel + '</button>' +
            '<button class="btn btn-danger btn-sm" onclick="deleteWebhook(\'' + escapeHtml(w.id) + '\', \'' + escapeHtml(w.url) + '\')">' + ICONS.trash + '</button>' +
          '</td>' +
        '</tr>';
      }).join('');
      staggerRows('webhooks-table');
    }

    // Create modal
    function openCreateModal() {
      document.getElementById('new-webhook-url').value = '';
      var checkboxes = document.querySelectorAll('#events-grid input[type="checkbox"]');
      checkboxes.forEach(function(cb) { cb.checked = false; });
      // Default: device.online and device.offline
      checkboxes.forEach(function(cb) {
        if (cb.value === 'device.online' || cb.value === 'device.offline') cb.checked = true;
      });
      document.getElementById('create-webhook-modal').style.display = 'flex';
    }
    function closeCreateModal() {
      document.getElementById('create-webhook-modal').style.display = 'none';
    }

    async function createWebhook() {
      var url = document.getElementById('new-webhook-url').value.trim();
      if (!url) { showToast('Webhook URL is required', 'error'); return; }

      var events = [];
      document.querySelectorAll('#events-grid input[type="checkbox"]:checked').forEach(function(cb) {
        events.push(cb.value);
      });
      if (events.length === 0) { showToast('Select at least one event', 'error'); return; }

      var result = await apiPost('/api/org/webhooks', { url: url, events: events });
      if (result && !result.error) {
        showToast('Webhook created', 'success');
        closeCreateModal();
        loadWebhooks();
      } else {
        showToast((result && result.error) || 'Failed to create webhook', 'error');
      }
    }

    async function toggleWebhook(webhookId, newActive) {
      var result = await apiPatch('/api/org/webhooks/' + encodeURIComponent(webhookId), { active: newActive });
      if (result && !result.error) {
        showToast('Webhook ' + (newActive ? 'enabled' : 'disabled'), 'success');
        loadWebhooks();
      } else {
        showToast((result && result.error) || 'Failed to update webhook', 'error');
      }
    }

    function deleteWebhook(webhookId, webhookUrl) {
      showConfirmModal(
        'Delete Webhook',
        'Are you sure you want to delete the webhook for ' + webhookUrl + '? This action cannot be undone.',
        async function() {
          var result = await apiDelete('/api/org/webhooks/' + encodeURIComponent(webhookId));
          if (result && !result.error) {
            showToast('Webhook deleted', 'success');
            loadWebhooks();
          } else {
            showToast((result && result.error) || 'Failed to delete webhook', 'error');
          }
        }
      );
    }

    loadWebhooks();
  </script>
</body>
</html>
