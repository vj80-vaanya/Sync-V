<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sync-V - Clusters</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/dashboard/css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div id="nav-bar"></div>

  <div class="page">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:8px">
      <div>
        <h1 class="page-title" style="margin-bottom:4px">Clusters</h1>
        <p class="page-subtitle" style="margin-bottom:0">Organize devices into logical groups</p>
      </div>
      <button class="btn btn-primary" id="create-cluster-btn" style="display:none" onclick="openCreateModal()">+ Create Cluster</button>
    </div>

    <!-- Cluster list view -->
    <div id="cluster-list-view">
      <div class="stats-grid" id="clusters-grid">
        <span class="loading">Loading clusters...</span>
      </div>
    </div>

    <!-- Cluster detail view (shown when a cluster is selected) -->
    <div id="cluster-detail-view" style="display:none">
      <a href="#" class="back-link" onclick="showListView();return false">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
        Back to Clusters
      </a>
      <div style="margin-top:16px">
        <h2 id="detail-cluster-name" style="font-size:22px;font-weight:800;color:var(--text-dark);margin-bottom:4px"></h2>
        <p id="detail-cluster-desc" style="font-size:14px;color:var(--text-light);margin-bottom:20px"></p>
      </div>

      <div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;align-items:center">
        <h3 style="font-size:14px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.6px;margin:0">Devices in Cluster</h3>
        <div style="flex:1"></div>
        <button class="btn btn-secondary btn-sm" id="assign-device-btn" onclick="openAssignModal()">+ Assign Device</button>
      </div>

      <div class="card">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Device ID</th>
                <th>Name</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="cluster-devices-table"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Cluster Modal -->
  <div id="create-cluster-modal" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeCreateModal()">
    <div class="modal-card" style="max-width:480px">
      <div class="modal-header">
        <h3>Create Cluster</h3>
        <button class="modal-close" onclick="closeCreateModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Cluster Name</label>
          <input type="text" id="new-cluster-name" placeholder="e.g. Factory Floor A" style="width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:8px;font-size:14px;font-family:var(--font-sans);color:var(--text-dark);outline:none">
        </div>
        <div class="form-group" style="margin-top:14px">
          <label>Description</label>
          <input type="text" id="new-cluster-desc" placeholder="Optional description" style="width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:8px;font-size:14px;font-family:var(--font-sans);color:var(--text-dark);outline:none">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeCreateModal()">Cancel</button>
        <button class="btn btn-primary" onclick="createCluster()">Create</button>
      </div>
    </div>
  </div>

  <!-- Assign Device Modal -->
  <div id="assign-device-modal" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeAssignModal()">
    <div class="modal-card" style="max-width:480px">
      <div class="modal-header">
        <h3>Assign Device to Cluster</h3>
        <button class="modal-close" onclick="closeAssignModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Device ID</label>
          <select id="assign-device-select" style="width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:8px;font-size:14px;font-family:var(--font-sans);color:var(--text-mid);background:var(--card);outline:none">
            <option value="">Select a device...</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeAssignModal()">Cancel</button>
        <button class="btn btn-primary" onclick="assignDevice()">Assign</button>
      </div>
    </div>
  </div>

  <script src="/dashboard/js/auth.js"></script>
  <script src="/dashboard/js/api.js"></script>
  <script src="/dashboard/js/app.js"></script>
  <script>
    if (!AUTH.requireAuth()) throw new Error('Not authenticated');

    // Build extended nav inline
    (function() {
      var user = AUTH.getUser();
      var pages = [
        { id: 'overview', label: 'Overview', href: '/dashboard/overview.html', icon: ICONS.overview },
        { id: 'devices', label: 'Devices', href: '/dashboard/devices.html', icon: ICONS.devices },
        { id: 'clusters', label: 'Clusters', href: '/dashboard/clusters.html', icon: ICONS.firmware },
        { id: 'logs', label: 'Logs', href: '/dashboard/logs.html', icon: ICONS.logs },
        { id: 'firmware', label: 'Firmware', href: '/dashboard/firmware.html', icon: ICONS.firmware },
        { id: 'team', label: 'Team', href: '/dashboard/team.html', icon: ICONS.devices },
        { id: 'api-keys', label: 'API Keys', href: '/dashboard/api-keys.html', icon: ICONS.firmware },
        { id: 'webhooks', label: 'Webhooks', href: '/dashboard/webhooks.html', icon: ICONS.logs },
        { id: 'audit', label: 'Audit', href: '/dashboard/audit.html', icon: ICONS.logs },
        { id: 'usage', label: 'Usage', href: '/dashboard/usage.html', icon: ICONS.overview }
      ];
      var linksHtml = pages.map(function(p) {
        var cls = p.id === 'clusters' ? ' class="active"' : '';
        return '<a href="' + p.href + '"' + cls + '>' + p.icon + ' ' + p.label + '</a>';
      }).join('');
      var userName = user ? user.username : '';
      var userRole = user ? user.role : '';
      var nav = document.getElementById('nav-bar');
      nav.className = 'nav-bar';
      nav.innerHTML =
        '<div class="nav-brand"><span class="logo-icon logo-icon-nav">' + BRAND_LOGO + '</span><span class="nav-brand-gradient">Sync-V</span></div>' +
        '<button class="nav-hamburger" onclick="toggleMobileNav()" aria-label="Menu">' + ICONS.hamburger + '</button>' +
        '<div class="nav-links" id="nav-links">' + linksHtml + '</div>' +
        '<div class="nav-user">' +
          '<button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme"></button>' +
          '<span>' + userName + '</span>' +
          '<span class="role">' + userRole + '</span>' +
          '<button class="logout-btn" onclick="AUTH.logout()">' + ICONS.logout + ' Logout</button>' +
        '</div>';
      updateThemeButtons(document.documentElement.getAttribute('data-theme') || 'dark');
    })();
    renderFooter();

    var user = AUTH.getUser();
    var isAdmin = user && (user.role === 'org_admin' || user.role === 'admin');
    if (isAdmin) {
      document.getElementById('create-cluster-btn').style.display = '';
    }

    var allClusters = [];
    var currentClusterId = null;

    async function loadClusters() {
      allClusters = await apiGet('/api/clusters') || [];
      renderClusters();
    }

    function renderClusters() {
      var grid = document.getElementById('clusters-grid');
      if (allClusters.length === 0) {
        grid.innerHTML = '<div class="card" style="grid-column:1/-1"><div class="empty-state">' +
          '<div class="empty-icon-circle">' + ICONS.emptyBox + '</div>' +
          '<h3>No clusters yet</h3><p>Create a cluster to organize your devices</p></div></div>';
        return;
      }
      grid.innerHTML = allClusters.map(function(c) {
        var deviceCount = c.device_count || c.deviceCount || 0;
        return '<div class="stat-card" style="cursor:pointer" onclick="openClusterDetail(\'' + escapeHtml(c.id) + '\')">' +
          '<div class="stat-value" style="font-size:18px;color:var(--text-dark)">' + escapeHtml(c.name) + '</div>' +
          '<div style="font-size:13px;color:var(--text-light);margin:6px 0 12px">' + escapeHtml(c.description || 'No description') + '</div>' +
          '<div style="display:flex;align-items:center;gap:8px">' +
            '<span class="badge badge-info">' + deviceCount + ' device' + (deviceCount !== 1 ? 's' : '') + '</span>' +
          '</div>' +
        '</div>';
      }).join('');
      staggerCards('#clusters-grid');
    }

    async function openClusterDetail(clusterId) {
      currentClusterId = clusterId;
      document.getElementById('cluster-list-view').style.display = 'none';
      document.getElementById('cluster-detail-view').style.display = '';

      var cluster = allClusters.find(function(c) { return c.id === clusterId; });
      document.getElementById('detail-cluster-name').textContent = cluster ? cluster.name : 'Cluster';
      document.getElementById('detail-cluster-desc').textContent = cluster ? (cluster.description || '') : '';

      // Load cluster dashboard / devices
      var data = await apiGet('/api/clusters/' + encodeURIComponent(clusterId) + '/dashboard');
      var devices = (data && data.devices) ? data.devices : (data || []);
      if (!Array.isArray(devices)) devices = [];

      var tbody = document.getElementById('cluster-devices-table');
      if (devices.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty-state">' +
          '<div class="empty-icon-circle">' + ICONS.emptyBox + '</div>' +
          '<h3>No devices assigned</h3><p>Assign devices to this cluster</p></td></tr>';
        return;
      }
      tbody.innerHTML = devices.map(function(d) {
        return '<tr style="cursor:default">' +
          '<td class="text-mono">' + escapeHtml(d.id || d.device_id) + '</td>' +
          '<td>' + escapeHtml(d.name || '-') + '</td>' +
          '<td>' + statusBadge(d.status || 'unknown') + '</td>' +
          '<td><button class="btn btn-danger btn-sm" onclick="removeDevice(\'' + escapeHtml(d.id || d.device_id) + '\')">' + ICONS.trash + ' Remove</button></td>' +
        '</tr>';
      }).join('');
      staggerRows('cluster-devices-table');
    }

    function showListView() {
      currentClusterId = null;
      document.getElementById('cluster-detail-view').style.display = 'none';
      document.getElementById('cluster-list-view').style.display = '';
      loadClusters();
    }

    // Create cluster modal
    function openCreateModal() {
      document.getElementById('new-cluster-name').value = '';
      document.getElementById('new-cluster-desc').value = '';
      document.getElementById('create-cluster-modal').style.display = 'flex';
    }
    function closeCreateModal() {
      document.getElementById('create-cluster-modal').style.display = 'none';
    }

    async function createCluster() {
      var name = document.getElementById('new-cluster-name').value.trim();
      if (!name) { showToast('Cluster name is required', 'error'); return; }
      var desc = document.getElementById('new-cluster-desc').value.trim();
      var result = await apiPost('/api/clusters', { name: name, description: desc });
      if (result && (result.id || result.clusterId)) {
        showToast('Cluster created: ' + name, 'success');
        closeCreateModal();
        loadClusters();
      } else {
        showToast((result && result.error) || 'Failed to create cluster', 'error');
      }
    }

    // Assign device modal
    async function openAssignModal() {
      var select = document.getElementById('assign-device-select');
      select.innerHTML = '<option value="">Loading devices...</option>';
      document.getElementById('assign-device-modal').style.display = 'flex';

      var devices = await apiGet('/api/devices') || [];
      select.innerHTML = '<option value="">Select a device...</option>';
      devices.forEach(function(d) {
        select.innerHTML += '<option value="' + escapeHtml(d.id) + '">' + escapeHtml(d.id) + ' - ' + escapeHtml(d.name || d.type) + '</option>';
      });
    }
    function closeAssignModal() {
      document.getElementById('assign-device-modal').style.display = 'none';
    }

    async function assignDevice() {
      var deviceId = document.getElementById('assign-device-select').value;
      if (!deviceId) { showToast('Select a device', 'error'); return; }
      var result = await apiPost('/api/clusters/' + encodeURIComponent(currentClusterId) + '/devices', { deviceId: deviceId });
      if (result && !result.error) {
        showToast('Device assigned to cluster', 'success');
        closeAssignModal();
        openClusterDetail(currentClusterId);
      } else {
        showToast((result && result.error) || 'Failed to assign device', 'error');
      }
    }

    function removeDevice(deviceId) {
      showConfirmModal(
        'Remove Device',
        'Remove device ' + deviceId + ' from this cluster?',
        async function() {
          var result = await apiDelete('/api/clusters/' + encodeURIComponent(currentClusterId) + '/devices/' + encodeURIComponent(deviceId));
          if (result && !result.error) {
            showToast('Device removed from cluster', 'success');
            openClusterDetail(currentClusterId);
          } else {
            showToast((result && result.error) || 'Failed to remove device', 'error');
          }
        }
      );
    }

    loadClusters();
  </script>
</body>
</html>
