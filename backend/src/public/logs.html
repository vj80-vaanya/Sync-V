<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sync-V - Logs</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/dashboard/css/style.css">
</head>
<body>
  <div id="nav-bar"></div>

  <div class="page">
    <h1 class="page-title">Log Browser</h1>
    <p class="page-subtitle">Uploaded log files from all devices</p>

    <div class="filter-bar">
      <div class="search-wrap">
        <span class="search-icon"></span>
        <input type="text" id="filter-device" placeholder="Filter by Device ID...">
      </div>
      <select id="filter-vendor"><option value="">All Vendors</option></select>
      <select id="filter-format"><option value="">All Formats</option></select>
      <button class="btn btn-secondary" onclick="filterLogs()">Filter</button>
      <button class="btn btn-ghost" onclick="clearFilter()">Clear</button>
      <div style="flex:1"></div>
      <button class="btn btn-secondary" id="export-csv-btn" onclick="exportLogsAsCsv(allLogs)"><span id="export-icon"></span> Export CSV</button>
    </div>

    <div class="card">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Log ID</th>
              <th>Device</th>
              <th>Filename</th>
              <th>Vendor</th>
              <th>Format</th>
              <th>Size</th>
              <th>Uploaded</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="logs-table"></tbody>
        </table>
      </div>
      <div id="pagination"></div>
    </div>
  </div>

  <!-- Preview Modal -->
  <div id="log-preview-modal" class="modal-overlay" style="display:none" onclick="if(event.target===this)closePreviewModal()">
    <div class="modal-card">
      <div class="modal-header">
        <h3 id="modal-title">Log Preview</h3>
        <button class="modal-close" onclick="closePreviewModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div style="margin-bottom:12px">
          <span id="modal-vendor"></span>
          <span id="modal-format" style="margin-left:6px"></span>
          <span id="modal-size" style="margin-left:12px;font-size:13px;color:var(--text-muted)"></span>
        </div>
        <pre class="log-content-pre" id="modal-content">Loading...</pre>
      </div>
      <div class="modal-footer">
        <a id="modal-view-full" class="btn btn-secondary btn-sm" href="#">View Full</a>
        <button id="modal-download-btn" class="btn btn-outline btn-sm" onclick="">Download</button>
        <button class="btn btn-ghost btn-sm" onclick="closePreviewModal()">Close</button>
      </div>
    </div>
  </div>

  <script src="/dashboard/js/auth.js"></script>
  <script src="/dashboard/js/api.js"></script>
  <script src="/dashboard/js/app.js"></script>
  <script>
    if (!AUTH.requireAuth()) throw new Error('Not authenticated');
    renderNavBar('logs');
    renderFooter();

    // Insert icons
    document.querySelector('.search-icon').innerHTML = ICONS.search;
    document.getElementById('export-icon').innerHTML = ICONS.exportCsv;

    // Show skeleton loading
    document.getElementById('logs-table').innerHTML = skeletonRows(5, 8);

    var allLogs = [];
    var currentPage = 1;
    var pageSize = 50;

    // Load filter dropdowns
    async function loadFilters() {
      var data = await apiGet('/api/logs/filters');
      if (!data) return;
      var vendorSel = document.getElementById('filter-vendor');
      var formatSel = document.getElementById('filter-format');
      (data.vendors || []).forEach(function(v) {
        var opt = document.createElement('option');
        opt.value = v; opt.textContent = v;
        vendorSel.appendChild(opt);
      });
      (data.formats || []).forEach(function(f) {
        var opt = document.createElement('option');
        opt.value = f; opt.textContent = f;
        formatSel.appendChild(opt);
      });
    }

    async function loadLogs() {
      allLogs = await apiGet('/api/dashboard/logs') || [];
      currentPage = 1;
      renderLogs(allLogs);

      // Setup sortable columns
      makeSortable('logs-table', allLogs, function(sorted) {
        allLogs = sorted;
        currentPage = 1;
        renderLogs(sorted);
      }, [
        { key: function(l) { return l.id; }, type: 'string' },
        { key: function(l) { return l.device_id; }, type: 'string' },
        { key: function(l) { return l.filename; }, type: 'string' },
        { key: function(l) { return l.vendor; }, type: 'string' },
        { key: function(l) { return l.format; }, type: 'string' },
        { key: function(l) { return l.size; }, type: 'number' },
        { key: function(l) { return l.uploaded_at; }, type: 'date' },
        null // actions â€” not sortable
      ]);
    }

    function getFilteredLogs() {
      var deviceFilter = document.getElementById('filter-device').value.trim();
      var vendorFilter = document.getElementById('filter-vendor').value;
      var formatFilter = document.getElementById('filter-format').value;
      var logs = allLogs;
      if (deviceFilter) logs = logs.filter(function(l) { return l.device_id === deviceFilter; });
      if (vendorFilter) logs = logs.filter(function(l) { return l.vendor === vendorFilter; });
      if (formatFilter) logs = logs.filter(function(l) { return l.format === formatFilter; });
      return logs;
    }

    function renderLogs(logs) {
      var tbody = document.getElementById('logs-table');
      var total = logs.length;
      var start = (currentPage - 1) * pageSize;
      var end = Math.min(start + pageSize, total);
      var shown = logs.slice(start, end);

      window._currentLogs = shown;

      if (total === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="empty-state">' +
          '<div class="empty-icon-circle">' + ICONS.emptyBox + '</div>' +
          '<h3>No logs found</h3></td></tr>';
        document.getElementById('pagination').innerHTML = '';
        return;
      }

      tbody.innerHTML = shown.map(function(log, idx) {
        return '<tr style="cursor:pointer" onclick="openPreviewModal(\'' + escapeHtml(log.id) + '\')">' +
          '<td class="text-mono"><span class="text-truncate">' + escapeHtml(log.id) + '</span></td>' +
          '<td><a href="/dashboard/device-detail.html?id=' + encodeURIComponent(log.device_id) + '" onclick="event.stopPropagation()">' + escapeHtml(log.device_id) + '</a></td>' +
          '<td>' + escapeHtml(log.filename) + '</td>' +
          '<td>' + vendorBadge(log.vendor) + '</td>' +
          '<td>' + formatBadge(log.format) + '</td>' +
          '<td>' + formatSize(log.size) + '</td>' +
          '<td>' + formatDate(log.uploaded_at) + '</td>' +
          '<td>' +
            '<button class="btn btn-outline btn-sm" onclick="event.stopPropagation();downloadLogRaw(\'' + escapeHtml(log.id) + '\',\'' + escapeHtml(log.filename) + '\')" title="Download raw">' + ICONS.download + '</button> ' +
            '<a class="btn btn-outline btn-sm" href="/dashboard/log-viewer.html?id=' + encodeURIComponent(log.id) + '" onclick="event.stopPropagation()" title="View full">View</a> ' +
            '<button class="btn btn-danger btn-sm" onclick="event.stopPropagation();deleteLog(\'' + escapeHtml(log.id) + '\',\'' + escapeHtml(log.filename) + '\')" title="Delete">' + ICONS.trash + '</button>' +
          '</td>' +
        '</tr>';
      }).join('');
      staggerRows('logs-table');

      // Pagination bar
      var pag = document.getElementById('pagination');
      var totalPages = Math.ceil(total / pageSize);
      pag.innerHTML = '<div class="pagination-bar">' +
        '<span class="pagination-info">Showing ' + (start + 1) + '-' + end + ' of ' + total + '</span>' +
        '<div class="pagination-controls">' +
          '<button class="btn btn-outline btn-sm" onclick="prevPage()" ' + (currentPage <= 1 ? 'disabled' : '') + '>' + ICONS.prev + ' Prev</button>' +
          '<button class="btn btn-outline btn-sm" onclick="nextPage()" ' + (currentPage >= totalPages ? 'disabled' : '') + '>Next ' + ICONS.next + '</button>' +
        '</div>' +
      '</div>';
    }

    function prevPage() {
      if (currentPage > 1) { currentPage--; renderLogs(getFilteredLogs()); }
    }

    function nextPage() {
      var logs = getFilteredLogs();
      var totalPages = Math.ceil(logs.length / pageSize);
      if (currentPage < totalPages) { currentPage++; renderLogs(logs); }
    }

    function filterLogs() {
      currentPage = 1;
      renderLogs(getFilteredLogs());
    }

    function clearFilter() {
      document.getElementById('filter-device').value = '';
      document.getElementById('filter-vendor').value = '';
      document.getElementById('filter-format').value = '';
      currentPage = 1;
      renderLogs(allLogs);
    }

    // Preview modal
    async function openPreviewModal(logId) {
      var modal = document.getElementById('log-preview-modal');
      modal.style.display = 'flex';
      document.getElementById('modal-content').textContent = 'Loading...';

      var log = await apiGet('/api/logs/' + encodeURIComponent(logId));
      if (!log) { document.getElementById('modal-content').textContent = 'Failed to load.'; return; }

      document.getElementById('modal-title').textContent = log.filename;
      document.getElementById('modal-vendor').innerHTML = vendorBadge(log.vendor);
      document.getElementById('modal-format').innerHTML = formatBadge(log.format);
      document.getElementById('modal-size').textContent = formatSize(log.size);

      var content = log.raw_data || '(no content)';
      if (content.length > 5000) content = content.substring(0, 5000) + '\n\n... truncated (view full for complete content)';
      document.getElementById('modal-content').textContent = content;

      document.getElementById('modal-view-full').href = '/dashboard/log-viewer.html?id=' + encodeURIComponent(logId);
      document.getElementById('modal-download-btn').onclick = function() { downloadLogRaw(logId, log.filename); };
    }

    function closePreviewModal() {
      document.getElementById('log-preview-modal').style.display = 'none';
    }

    function deleteLog(logId, filename) {
      showConfirmModal(
        'Delete Log',
        'Are you sure you want to delete "' + filename + '"? This action cannot be undone.',
        async function() {
          var result = await apiDelete('/api/logs/' + encodeURIComponent(logId));
          if (result && result.success) {
            showToast('Log deleted: ' + filename, 'success');
            loadLogs();
          } else {
            showToast((result && result.error) || 'Failed to delete log', 'error');
          }
        }
      );
    }

    loadFilters();
    loadLogs();
  </script>
</body>
</html>
