<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sync-V - Log Viewer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/dashboard/css/style.css">
</head>
<body>
  <div id="nav-bar"></div>

  <div class="page">
    <a href="/dashboard/logs.html" class="back-link" id="back-link">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
      Back to Logs
    </a>

    <h1 class="page-title" id="viewer-title" style="margin-top:12px">Log Viewer</h1>
    <p class="page-subtitle" id="viewer-subtitle">Loading...</p>

    <div class="log-viewer-layout">
      <!-- Main content area -->
      <div>
        <!-- Search bar -->
        <div class="filter-bar" style="margin-bottom:12px">
          <div class="search-wrap">
            <span class="search-icon"></span>
            <input type="text" id="content-search" placeholder="Search in log content..." oninput="searchContent()">
          </div>
          <span id="search-count" style="font-size:13px;color:var(--text-muted)"></span>
          <div style="flex:1"></div>
          <button class="btn btn-outline btn-sm" id="download-btn" onclick="" disabled>Download</button>
        </div>

        <div class="card" style="padding:0">
          <pre class="log-content-pre" id="log-content" style="margin:0;border:none;border-radius:var(--radius);max-height:70vh">Loading...</pre>
        </div>
      </div>

      <!-- Metadata sidebar -->
      <div class="log-viewer-sidebar">
        <div class="card">
          <div class="card-title">Metadata</div>
          <div id="metadata-panel">
            <div class="skeleton skeleton-text" style="width:80%"></div>
            <div class="skeleton skeleton-text" style="width:60%"></div>
            <div class="skeleton skeleton-text" style="width:70%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/dashboard/js/auth.js"></script>
  <script src="/dashboard/js/api.js"></script>
  <script src="/dashboard/js/app.js"></script>
  <script>
    if (!AUTH.requireAuth()) throw new Error('Not authenticated');
    renderNavBar('logs');
    renderFooter();

    document.querySelector('.search-icon').innerHTML = ICONS.search;

    var logData = null;
    var rawContent = '';
    var MAX_DISPLAY = 10 * 1024 * 1024; // 10MB truncation guard

    async function loadLog() {
      var params = new URLSearchParams(window.location.search);
      var logId = params.get('id');
      if (!logId) {
        document.getElementById('log-content').textContent = 'No log ID specified.';
        return;
      }

      logData = await apiGet('/api/logs/' + encodeURIComponent(logId));
      if (!logData) {
        document.getElementById('log-content').textContent = 'Log not found.';
        document.getElementById('viewer-subtitle').textContent = 'Error loading log';
        return;
      }

      document.getElementById('viewer-title').textContent = logData.filename;
      document.getElementById('viewer-subtitle').innerHTML =
        vendorBadge(logData.vendor) + ' ' + formatBadge(logData.format) +
        ' <span style="margin-left:8px;color:var(--text-muted)">' + formatSize(logData.size) + '</span>';

      // Render content
      rawContent = logData.raw_data || '';
      var displayContent = rawContent;
      if (displayContent.length > MAX_DISPLAY) {
        displayContent = displayContent.substring(0, MAX_DISPLAY) +
          '\n\n--- Content truncated at 10MB. Download the full file for complete content. ---';
      }

      // Format-aware rendering
      if (logData.format === 'json' && rawContent.length < MAX_DISPLAY) {
        try {
          var parsed = JSON.parse(rawContent);
          displayContent = JSON.stringify(parsed, null, 2);
        } catch(e) { /* leave as-is */ }
      }

      document.getElementById('log-content').textContent = displayContent || '(no content)';

      // Setup download button
      var dlBtn = document.getElementById('download-btn');
      dlBtn.disabled = false;
      dlBtn.innerHTML = ICONS.download + ' Download';
      dlBtn.onclick = function() { downloadLogRaw(logData.id, logData.filename); };

      // Render metadata sidebar
      renderMetadata(logData);
    }

    function renderMetadata(log) {
      var panel = document.getElementById('metadata-panel');
      var meta = '';
      try { meta = JSON.parse(log.metadata || '{}'); } catch(e) { meta = {}; }
      var metaStr = Object.keys(meta).length > 0
        ? Object.keys(meta).map(function(k) { return escapeHtml(k) + ': ' + escapeHtml(meta[k]); }).join('<br>')
        : '<span style="color:var(--text-muted)">None</span>';

      panel.innerHTML =
        '<div class="detail-row"><span class="detail-key">Log ID</span><span class="detail-value text-mono" style="font-size:11px;word-break:break-all">' + escapeHtml(log.id) + '</span></div>' +
        '<div class="detail-row"><span class="detail-key">Device</span><span class="detail-value"><a href="/dashboard/device-detail.html?id=' + encodeURIComponent(log.device_id) + '">' + escapeHtml(log.device_id) + '</a></span></div>' +
        '<div class="detail-row"><span class="detail-key">Vendor</span><span class="detail-value">' + vendorBadge(log.vendor) + '</span></div>' +
        '<div class="detail-row"><span class="detail-key">Format</span><span class="detail-value">' + formatBadge(log.format) + '</span></div>' +
        '<div class="detail-row"><span class="detail-key">Size</span><span class="detail-value">' + formatSize(log.size) + '</span></div>' +
        '<div class="detail-row"><span class="detail-key">Checksum</span><span class="detail-value text-mono" style="font-size:10px;word-break:break-all">' + escapeHtml(log.checksum) + '</span></div>' +
        '<div class="detail-row"><span class="detail-key">Uploaded</span><span class="detail-value">' + formatDate(log.uploaded_at) + '</span></div>' +
        '<div class="detail-row"><span class="detail-key">Metadata</span><span class="detail-value" style="font-size:12px">' + metaStr + '</span></div>';
    }

    function searchContent() {
      var query = document.getElementById('content-search').value;
      var pre = document.getElementById('log-content');
      var countEl = document.getElementById('search-count');

      if (!query || !rawContent) {
        pre.textContent = rawContent || '(no content)';
        countEl.textContent = '';
        return;
      }

      // Escape HTML in content first, then highlight matches
      var escaped = escapeHtml(rawContent);
      var escapedQuery = escapeHtml(query);
      var regex;
      try {
        // Escape regex special chars in the query
        var safeQuery = escapedQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        regex = new RegExp('(' + safeQuery + ')', 'gi');
      } catch(e) {
        pre.textContent = rawContent;
        countEl.textContent = '';
        return;
      }

      var matches = escaped.match(regex);
      var count = matches ? matches.length : 0;
      countEl.textContent = count + ' match' + (count !== 1 ? 'es' : '');

      if (count > 0) {
        pre.innerHTML = escaped.replace(regex, '<span class="search-highlight">$1</span>');
      } else {
        pre.textContent = rawContent;
      }
    }

    loadLog();
  </script>
</body>
</html>
